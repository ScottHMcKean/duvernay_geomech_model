---
title: "Geostatistics CoSimulation"
author: "Scott McKean"
date: "05/02/2021"
output: html_document
---

# Stress Cosimulation

This document goes over development of a LMC and cosimulation of stress data

```{r setup, include=FALSE}
# geospatial packages
library(sf)
library(gstat)
library(sp)

# statistical normalization and analysis
library(moments)
library(bestNormalize)
```

## Load spatial dataframes

See 'geostats_data_prep.Rmd' to generate these files and dump into the cache.
Read GeoJSONs from the cache.

```{r cars}
sv_sf = st_read('../cache/sv_sf.GeoJSON')
pp_sf = st_read('../cache/pp_sf.GeoJSON')
shmin_sf = st_read('../cache/shmin_sf.GeoJSON')
```
# Variography

This section investigates the normality, anisotropy, and variography of each of 
the stress variables. 

Since Sequential Gaussian Cosimulation is used, we transform variables to normal 
distributions using the ordered quantile technique 

## Descriptive Variography - SV

```{r}
sv_sp = as_Spatial(sv_sf)

```

## Descriptive Variography - SV

```{r}
pp_sp = as_Spatial(pp_sf)

```

## Descriptive Variography - SV

```{r}
shmin_sp = as_Spatial(shmin_sf)

```


## Cosimulation 

We are going to cosimulate stress values using a Linear Model of Coregionalization (LMC)
via gstat. We could get fancier, but that's not what is important, what is important
is that we have heterotopic data underpinned by an exhaustive secondary variable
and need to quantify the uncertainty in our stress measurements, and how that 
compares to our model uncertainty.

```{r}




# we can load all data into a gstat despite different support 
# this is good
g = gstat(id='sv', formula=svgrad_kpa_m~1, data=sv_sp)
g = gstat(g, id='pp', formula=ppgrad_kpa_m~1, data=pp_sp)
g = gstat(g, id='shmin', formula=shmingrad_kpa_m~1, data=shmin_sp)
```

Describe the distribution of our secondary variable (Sv). The distribution
is fairly symettrical but shows kurtosis.
George & Mallery, 2010). 

- Check skewness and kurtosis

We should perform an NScore Transform

```{r}
# investigate normality


# make an experimental variogram
sv_v = variogram(svgrad_kpa_m~1, sv_sp)
plot(sv_v)

# check directional variograms
sv_v_dir = variogram(svgrad_kpa_m~1, sv_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(sv_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = svgrad_kpa_m~1, 
  sp_df = sv_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 500
  )

# make anisotropic variograms

moments::skewness(sv_sf$svgrad_kpa_m)
moments::kurtosis(sv_sf$svgrad_kpa_m)

sv_norm = orderNorm(sv_sf$svgrad_kpa_m)
sv_sf$svgrad_norm = sv_norm$x.t

moments::skewness(sv_norm$x.t)
moments::kurtosis(sv_norm$x.t)

# variogram map for geometrical anisotropy


ggdensity(sv_sf, x='svgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
```

```{r}
ggplot(sv_sf) +
  geom_density(aes(svgrad_kpa_m)) +
  stat



ggdensity(df, x = "CONT", fill = "lightgray", title = "CONT") +
  scale_x_continuous(limits = c(3, 12)) +
  stat_overlay_normal_density(color = "red", linetype = "dashed")


plot(sv_v)
zon_rg = 50E3
zon_90 = vgm(0.58, "Sph", 1E12, anis=c(0, 50E3/1E12))
zon_0 = vgm(0.45, "Sph", 1E12, anis=c(90,30E3/1E12))
vm = vgm(0.45, "Exp", 30E3, add.to = zonal)


plot(sv_vmap, threshold =500)

  





plot(sv_v,zon_0)
```

```{r}
# fit sv model with geometric anisotropy - same variograms, but with a different
# range

vgm_mod = vgm(anis=c(0,0.5), range = 800000, anis1=0.2, anis2=0.4)

vgm_mod = vgm(psill=0.4, "Sph", 20000, nugget=0, alpha = 90)
x = vgm(psill=0.6, "Lin", 45000, nugget=0, alpha = 0, add.to=x)




plot(sv_vgm)
x = vgm("Sph",anis=c(90,0.1)) 
x = vgm("Lin",0, anis=c(90,0.1),add.to=x)
x = vgm("Exp", add.to=x)


sv_vgm_fit = fit.variogram(sv_vgm, model=vgm_mod)
sv_vgm_fit$ang1 = c(0,90)
plot(sv_vgm, sv_vgm_fit)
x

data(meuse)
coordinates(meuse) = ~x+y
# let's do some manual fitting of two direct variograms and a cross variogram
g <- gstat(id = "ln.zinc", formula = log(zinc)~1, data = meuse)
g <- gstat(g, id = "ln.lead", formula = log(lead)~1, data = meuse)
# examine variograms and cross variogram:
plot(variogram(g))
# enter direct variograms:
g <- gstat(g, id = "ln.zinc", model = vgm(.55, "Sph", 900, .05))
g <- gstat(g, id = "ln.lead", model = vgm(.55, "Sph", 900, .05))
# enter cross variogram:
g <- gstat(g, id = c("ln.zinc", "ln.lead"), model = vgm(.47, "Sph", 900, .03))
plot(variogram(g), model = g$model, main = "models fitted by eye")
```

```{r}
demo(meuse,ask=FALSE,echo=FALSE)
v = variogram(log(zinc)~1, meuse, alpha = c(0,45,90,135))
vm = vgm(.25, "Sph", 1000, anis = c(45, 0.5))
plot(v, vm, main = "geometric")
zonal = vgm(.5, "Sph", 1e9, anis = c(45, 1/1e6))
vm = vgm(.25, "Sph", 1000, add.to = zonal)
plot(v, vm, main = "zonal")

```

```{r}
vgm()
vgm("Sph")
vgm(NA, "Sph", NA, NA)
vgm(, "Sph") # "Sph" is second argument: NO nugget in this case
vgm(10, "Exp", 300)
x <- vgm(10, "Exp", 300)
vgm(10, "Nug", 0)
vgm(10, "Exp", 300, 4.5)
vgm(10, "Mat", 300, 4.5, kappa = 0.7)
x = vgm( 10, "Exp", 600, add.to = x)
vgm(10, "Exp", 300, anis = c(30, 0.5))
vgm(10, "Exp", 300, anis = c(30, 10, 0, 0.5, 0.3))
# Matern variogram model:
vgm(1, "Mat", 1, kappa=.3)
x <- vgm(0.39527463, "Sph", 953.8942, nugget = 0.06105141)
x
print(x, digits = 3);
# to see all components, do
print.data.frame(x)
vv=vgm(model = "Tab",  covtable = 
	variogramLine(vgm(1, "Sph", 1), 1, n=1e4, min = 0, covariance = TRUE))
vgm(c("Mat", "Sph"))
vgm(, c("Mat", "Sph")) # no nugget

```
