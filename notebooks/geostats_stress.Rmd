---
title: "Geostatistics CoSimulation"
author: "Scott McKean"
date: "05/02/2021"
output: html_document
---

# Stress Cosimulation

This document goes over development of a LMC and cosimulation of stress data

```{r setup, include=FALSE}
# geospatial packages
library(sf)
library(gstat)
library(raster)
library(sp)

# statistical normalization and analysis
library(ggpubr)
library(moments)
library(bestNormalize)

# data munging & plotting
library(tidyverse)
library(viridis)

source('../R/geospatial.R')
```

## Load spatial dataframes

See 'geostats_data_prep.Rmd' to generate these files and dump into the cache.
Read GeoJSONs from the cache.

We run an aggregation function to take the mean gradient across measurement
points because a) we aren't doing 3D kriging, and b) because geostatistics doesn't
work with zero distance variance that isn't equal to zero

```{r cars}
sv_sf = st_read('../cache/sv_sf.GeoJSON') 
pp_sf = st_read('../cache/pp_sf.GeoJSON') 
pp_sf = pp_sf %>% 
  aggregate(., by=pp_sf %>% distinct(), mean)
shmin_sf = st_read('../cache/shmin_sf.GeoJSON') 
shmin_sf = shmin_sf %>% 
  aggregate(., by=shmin_sf %>% distinct(), mean)
```
# Variography

This section investigates the normality, anisotropy, and variography of each of 
the stress variables. 

Since Sequential Gaussian Cosimulation is used, we transform variables to normal 
distributions using the ordered quantile technique 

## Descriptive Variography - SV

```{r}
sv_sp = as_Spatial(sv_sf)
# investigate normality

# make anisotropic variograms
ggdensity(sv_sf, x='svgrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sv_sf$svgrad_kpa_m)
moments::kurtosis(sv_sf$svgrad_kpa_m)

sv_norm = bestNormalize::orderNorm(sv_sf$svgrad_kpa_m)
sv_sf$svgrad_norm = sv_sp$svgrad_norm = sv_norm$x.t
ggdensity(sv_sf, x='svgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sv_norm$x.t)
moments::kurtosis(sv_norm$x.t)

# what is the global variance (should be 1...)
var(sv_sp$svgrad_norm)

# make an experimental variogram
sv_v = variogram(svgrad_norm~1, sv_sp)
plot(sv_v)

# check directional variograms
sv_v_dir = variogram(svgrad_norm~1, sv_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(sv_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = svgrad_norm~1, 
  sp_df = sv_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 500
  )
```

## Variogram Modelling - SV

Vertical stress shows geometric anisotropy with a major axis
direction of 157 degrees, and a trend in the shorter direction. Because we are 
trying to fit an LMC, we try to keep variogram structures simple. A anisotropy 
of 75% reflects the variogram map nicely. Good enough to start.

We use only spherical and nugget models to keep things simple. To make a valid
model, every model should have one nugget and two spherical variograms.

```{r}
sv_v = variogram(svgrad_norm~1, sv_sp, alpha=c(67,157)) 
plot(sv_v)

sv_vgm = vgm(0.69, "Sph", 50E3, nugget = 0.01)
sv_vgm = vgm(0.3, "Sph", 15E3, anis=c(67, 0.75), add.to=sv_vgm)
plot(sv_v, sv_vgm)
```
## Descriptive Variography - SV

Looking at pore pressure, there is an outlier in the data because two points are
way above the duvernay. A couple observations:
- The low pressures towards the east are creating a binomial distribution but I 
don't think they should be throw out.
- The data is quite skewed (-0.82) with heavy tails (k=3.6)
- The variograms are awful. I honestly think a pure nugget effect might be the
best way to look at them!?
- You can see the data sparsity in the variogram map - patchy with no discernable
anisotropy.

```{r}
pp_sp = as_Spatial(pp_sf)
# investigate normality

# make anisotropic variograms
ggdensity(pp_sf, x='ppgrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(pp_sf$ppgrad_kpa_m)
moments::kurtosis(pp_sf$ppgrad_kpa_m)

# normal transform
pp_norm = bestNormalize::orderNorm(pp_sf$ppgrad_kpa_m)
pp_sf$ppgrad_norm = pp_sp$ppgrad_norm = pp_norm$x.t
ggdensity(pp_sf, x='ppgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(pp_norm$x.t)
moments::kurtosis(pp_norm$x.t)

# what is the global variance (should be 1...)
var(pp_sp$ppgrad_norm)

# make an experimental variogram
pp_v = variogram(ppgrad_norm~1, pp_sp)
plot(pp_v)

# check directional variograms
pp_v_dir = variogram(ppgrad_norm~1, pp_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(pp_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = ppgrad_norm~1, 
  sp_df = pp_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 1
  )
```

## Variogram Modelling - SV

A uninformative variogram here might be best solution. We use a spherical variogram with a short range (10 km) to fit our first observation. We need a model, so this is a pretty broad assumption. The other alternative is full nugget, but that simply imparts random noise and isn't all that useful for cosimulation.

```{r}
pp_v = variogram(ppgrad_norm~1, pp_sp, alpha=c(67,157))

pp_vgm = vgm(0.1, "Sph", 50E3, nugget = 0.1)
pp_vgm = vgm(0.85, "Sph", 15E3, anis=c(67, 0.75), add.to=pp_vgm)
plot(pp_v, pp_vgm)

pp_vgm
```
## Descriptive Variography - Minimum Horizontal Stress

- Actually, shmin isn't horribly non-normal (surprisingly), with nearly no skewness (-0.10) and light tails (k=2.07). But once again (as with pp), the variogram looks 
like garbage and the data is very sparse.

```{r}
sh_sp = as_Spatial(shmin_sf)
# investigate normality

# make anisotropic variograms
ggdensity(shmin_sf, x='shmingrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(shmin_sf$shmingrad_kpa_m)
moments::kurtosis(shmin_sf$shmingrad_kpa_m)

# normal transform
sh_norm = bestNormalize::orderNorm(shmin_sf$shmingrad_kpa_m)
shmin_sf$shgrad_norm = sh_sp$shgrad_norm = sh_norm$x.t
ggdensity(shmin_sf, x='shgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sh_norm$x.t)
moments::kurtosis(sh_norm$x.t)

# what is the global variance (should be 1...)
var(sh_sp$shgrad_norm)

# make an experimental variogram
sh_v = variogram(shgrad_norm~1, sh_sp)
plot(sh_v)

# check directional variograms
sh_v_dir = variogram(shgrad_norm~1, sh_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(sh_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = shgrad_norm~1, 
  sp_df = sh_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 1
  )
```

## Variogram Modelling - SV

We apply the same variogram as pore pressure

```{r}
sh_v = variogram(shgrad_norm~1, sh_sp, alpha=c(67,157))

sh_vgm = vgm(0.5, "Sph", 50E3, nugget = 0.1)
sh_vgm = vgm(0.5, "Sph", 15E3, anis=c(157, 0.5), add.to=sh_vgm)
plot(sh_v, sh_vgm)
sh_vgm
```


## Cosimulation 

We are going to cosimulate stress values using a Linear Model of Coregionalization (LMC)
via gstat. We could get fancier, but that's not what is important, what is important
is that we have heterotopic data underpinned by an exhaustive secondary variable
and need to quantify the uncertainty in our stress measurements, and how that 
compares to our model uncertainty.

We first try with two variables to develop intuition about cross-variogram fitting

```{r}
# make a prediction grid
st_grid <- rasterToPoints(study_raster, spatial = TRUE)
gridded(st_grid) <- TRUE
st_grid <- as(st_grid, "SpatialPixels")
```

```{r}
```

```{r}
vec = c(1,0.5,0.5,0,0,0)
names(vec) = c('sv','sh', 'pp', 'sv-sh', 'sv-pp', 'sh-pp')

mat = matrix(
  c(vec['sv'], vec['sv-sh'], vec['sv-pp'], 
    vec['sv-sh'], vec['sh'], vec['sh-pp'], 
    vec['sv-pp'], vec['sh-pp'], vec['pp']),
  nrow=3
)

posdef(mat)
```
```{r}

```


Try to see if we can fit an LMC using the eyeballed variograms

```{r}
# secondary (SV)
sv_vgm = vgm(0, "Sph", 50E3)
sv_vgm = vgm(0, "Lin", 10E3, add.to=sv_vgm)
sv_vgm = vgm(0, "Sph", 1E3, add.to=sv_vgm)
g = gstat(id='sv', formula=svgrad_norm~1, data=sv_sp, beta=0, nmax=50)
g = gstat(g, id='sv', model=sv_vgm)

# primary (SH)
sh_vgm = vgm(0, "Sph", 50E3)
sh_vgm = vgm(0, "Lin", 10E3, add.to=sh_vgm)
sh_vgm = vgm(0, "Sph", 1E3, add.to=sh_vgm)
g = gstat(g, id='shmin', formula=shgrad_norm~1, data=sh_sp, beta=0, nmax=50)
g = gstat(g, id='shmin', model=sh_vgm)

# primary (PP)
pp_vgm = vgm(0, "Sph", 50E3)
pp_vgm = vgm(0, "Lin", 10E3, add.to=pp_vgm)
pp_vgm = vgm(0, "Sph", 1E3, add.to=pp_vgm)
g = gstat(g, id='pp', formula = ppgrad_norm~1, data=pp_sp, beta=0, nmax=50)
g = gstat(g, id='pp', model=pp_vgm)

# covariance
sv_sh_vgm = vgm(0, "Sph", 50E3)
sv_sh_vgm = vgm(0, "Lin", 10E3, add.to = sv_sh_vgm)
sv_sh_vgm = vgm(0, "Sph", 1E3, add.to=sv_sh_vgm)
g = gstat(g, id=c('sv','shmin'), model=sv_sh_vgm, beta=0, nmax=50)

sv_pp_vgm = vgm(0, "Sph", 50E3)
sv_pp_vgm = vgm(0, "Lin", 10E3, add.to = sv_pp_vgm)
sv_pp_vgm = vgm(0, "Sph", 1E3, add.to=sv_pp_vgm)
g = gstat(g, id=c('sv','pp'), model=sv_pp_vgm, beta=0, nmax=50)

sh_pp_vgm = vgm(0, "Sph", 50E3)
sh_pp_vgm = vgm(0, "Lin", 10E3, add.to = sh_pp_vgm)
sh_pp_vgm = vgm(0, "Sph", 1E3, add.to=sh_pp_vgm)
g = gstat(g, id=c('shmin','pp'), model=sh_pp_vgm, beta=0, nmax=50)

v = variogram(g)

g = fit.lmc(v,g, fit.ranges=FALSE, fit.lmc =TRUE, fit.sills=TRUE, fit.method=7)

plot(v,g)
g
```

Do conditional Gaussian cosimulation with three variables, a local neighbourhood of 50 points.

The LMC is likely a poor representation, representing a maximum likelihood estimation given positive definiteness, however, a Bayesian approach would likely be better... but for the purposes of this study we don't care.

This fit isn't significantly improved by simulating two variables at a time, so we stick with a full cosimulation with LMC, despite a poor fit of the LMC. Bayesian methods may be able to improve upon this, but it still serves the point of quantifying uncertainty.

- Matrices are positive definite
- Matrices pass Cauchy-Schwartz inequality
- Simulation relies primarily on the cross-variograms, which means the absolute values may very but the relative difference should be minimized, which is very important for this study.

```{r}
g$set = list(nocheck=1)
pred = predict(g, st_grid, nsim=10)
```
