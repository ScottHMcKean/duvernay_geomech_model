---
title: "Geostatistics CoSimulation"
author: "Scott McKean"
date: "05/02/2021"
output: html_document
---

# Stress Cosimulation

This document goes over development of a LMC and cosimulation of stress data

```{r setup, include=FALSE}
# geospatial packages
library(sf)
library(gstat)
library(sp)

# statistical normalization and analysis
library(ggpubr)
library(moments)
library(bestNormalize)

# data munging & plotting
library(tidyverse)
library(viridis)
```

## Load spatial dataframes

See 'geostats_data_prep.Rmd' to generate these files and dump into the cache.
Read GeoJSONs from the cache.

```{r cars}
sv_sf = st_read('../cache/sv_sf.GeoJSON')
pp_sf = st_read('../cache/pp_sf.GeoJSON')
shmin_sf = st_read('../cache/shmin_sf.GeoJSON')
```
# Variography

This section investigates the normality, anisotropy, and variography of each of 
the stress variables. 

Since Sequential Gaussian Cosimulation is used, we transform variables to normal 
distributions using the ordered quantile technique 

## Descriptive Variography - SV

```{r}
sv_sp = as_Spatial(sv_sf)
# investigate normality

# make anisotropic variograms
ggdensity(sv_sf, x='svgrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sv_sf$svgrad_kpa_m)
moments::kurtosis(sv_sf$svgrad_kpa_m)

sv_norm = bestNormalize::orderNorm(sv_sf$svgrad_kpa_m)
sv_sf$svgrad_norm = sv_sp$svgrad_norm = sv_norm$x.t
ggdensity(sv_sf, x='svgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sv_norm$x.t)
moments::kurtosis(sv_norm$x.t)

# what is the global variance (should be 1...)
var(sv_sp$svgrad_norm)

# make an experimental variogram
sv_v = variogram(svgrad_norm~1, sv_sp)
plot(sv_v)

# check directional variograms
sv_v_dir = variogram(svgrad_norm~1, sv_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(sv_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = svgrad_norm~1, 
  sp_df = sv_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 500
  )
```

## Variogram Modelling - SV

Vertical stress shows geometric anisotropy with a major axis
direction of 157 degrees, and a trend in the shorter direction. Because we are 
trying to fit an LMC, we try to keep variogram structures simple. A anisotropy 
of 75% reflects the variogram map nicely. Good enough to start.

```{r}
sv_v = variogram(svgrad_norm~x+y, sv_sp, alpha=c(67,157)) 
plot(sv_v)

sv_vgm = vgm(0.3, "Lin", 15E3, anis=c(67, 0.75))
sv_vgm = vgm(0.7, "Sph", 50E3, add.to=sv_vgm)
plot(sv_v, sv_vgm)

```
## Descriptive Variography - SV

Looking at pore pressure, there is an outlier in the data because two points are
way above the duvernay. A couple observations:
- The low pressures towards the east are creating a binomial distribution but I 
don't think they should be throw out.
- The data is quite skewed (-0.82) with heavy tails (k=3.6)
- The variograms are awful. I honestly think a pure nugget effect might be the
best way to look at them!?
- You can see the data sparsity in the variogram map - patchy with no discernable
anisotropy.

```{r}
pp_sp = as_Spatial(pp_sf)
# investigate normality

# make anisotropic variograms
ggdensity(pp_sf, x='ppgrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(pp_sf$ppgrad_kpa_m)
moments::kurtosis(pp_sf$ppgrad_kpa_m)

# normal transform
pp_norm = bestNormalize::orderNorm(pp_sf$ppgrad_kpa_m)
pp_sf$ppgrad_norm = pp_sp$ppgrad_norm = pp_norm$x.t
ggdensity(pp_sf, x='ppgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(pp_norm$x.t)
moments::kurtosis(pp_norm$x.t)

# what is the global variance (should be 1...)
var(pp_sp$ppgrad_norm)

# make an experimental variogram
pp_v = variogram(ppgrad_norm~1, pp_sp)
plot(pp_v)

# check directional variograms
pp_v_dir = variogram(ppgrad_norm~1, pp_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(pp_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = ppgrad_norm~1, 
  sp_df = pp_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 1
  )
```

## Variogram Modelling - SV

A uninformative variogram here might be best solution. We use a spherical variogram with a short range (10 km) to fit our first observation. We need a model, so this is a pretty broad assumption. The other alternative is full nugget, but that simply imparts random noise and isn't all that useful for cosimulation.

```{r}
pp_v = variogram(ppgrad_norm~1, pp_sp)
pp_v$dist[1] = 100
pp_vgm = vgm(1, "Sph", 10000)
plot(pp_v, pp_vgm)
```
## Descriptive Variography - Minimum Horizontal Stress

- Actually, shmin isn't horribly non-normal (surprisingly), with nearly no skewness (-0.10) and light tails (k=2.07). But once again (as with pp), the variogram looks 
like garbage and the data is very sparse.

```{r}
sh_sp = as_Spatial(shmin_sf)
# investigate normality

# make anisotropic variograms
ggdensity(shmin_sf, x='shmingrad_kpa_m') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(shmin_sf$shmingrad_kpa_m)
moments::kurtosis(shmin_sf$shmingrad_kpa_m)

# normal transform
sh_norm = bestNormalize::orderNorm(shmin_sf$shmingrad_kpa_m)
shmin_sf$shgrad_norm = sh_sp$shgrad_norm = sh_norm$x.t
ggdensity(shmin_sf, x='shgrad_norm') +
  stat_overlay_normal_density(color='red', linetype='dashed')
moments::skewness(sh_norm$x.t)
moments::kurtosis(sh_norm$x.t)

# what is the global variance (should be 1...)
var(sh_sp$shgrad_norm)

# make an experimental variogram
sh_v = variogram(shgrad_norm~1, sh_sp)
plot(sh_v)

# check directional variograms
sh_v_dir = variogram(shgrad_norm~1, sh_sp, alpha=c(0,22,45,67,90,112,135,157))
plot(sh_v_dir)

# check for geometric anisotropy
ggvariogram_map(
  formula = shgrad_norm~1, 
  sp_df = sh_sp,
  cutoff = 100E3, 
  width = 5E3,
  threshold = 1
  )
```

## Variogram Modelling - SV

We apply the same variogram as pore pressure

```{r}
sh_v = variogram(shgrad_norm~1, sh_sp)
sh_vgm = vgm(1, "Sph", 10000)
plot(sh_v, sh_vgm)
```
```


## Cosimulation 

We are going to cosimulate stress values using a Linear Model of Coregionalization (LMC)
via gstat. We could get fancier, but that's not what is important, what is important
is that we have heterotopic data underpinned by an exhaustive secondary variable
and need to quantify the uncertainty in our stress measurements, and how that 
compares to our model uncertainty.

```{r}
# we can load all data into a gstat despite different support 
# this is good
g = gstat(id='sv', formula=svgrad_norm~1, data=sv_sp)
g = gstat(g, id='pp', formula=ppgrad_norm~1, data=pp_sp)
g = gstat(g, id='shmin', formula=shgrad_kpa_m~1, data=sh_sp)
```

Describe the distribution of our secondary variable (Sv). The distribution
is fairly symettrical but shows kurtosis.
George & Mallery, 2010). 

- Check skewness and kurtosis

We should perform an NScore Transform

```{r}
# investigate normality




```

```{r}
ggplot(sv_sf) +
  geom_density(aes(svgrad_kpa_m)) +
  stat



ggdensity(df, x = "CONT", fill = "lightgray", title = "CONT") +
  scale_x_continuous(limits = c(3, 12)) +
  stat_overlay_normal_density(color = "red", linetype = "dashed")


plot(sv_v)
zon_rg = 50E3
zon_90 = vgm(0.58, "Sph", 1E12, anis=c(0, 50E3/1E12))
zon_0 = vgm(0.45, "Sph", 1E12, anis=c(90,30E3/1E12))
vm = vgm(0.45, "Exp", 30E3, add.to = zonal)
```
