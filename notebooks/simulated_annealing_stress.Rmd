---
title: "lmc_mcmc"
author: "Scott McKean"
date: "22/02/2021"
output: html_document
---

Port of Emery's SA algorithm for LMC fitting

```{r setup, include=FALSE}
library(tidyverse)
source('../R/geostats.R')
library(gstat)
```

## Inputs 
Parse gstat code for variogram stats and variogram

Try three structures - nugget, linear, spherical
```{r}
# load variogram variogram export
vgm_import = readRDS('stress_vgm_sa_export.rds')

# specify variogram
azimuth = vgm_import$vgm_stats %>% pull(azimuth)
dip = vgm_import$vgm_stats %>% pull(dip)
nlag = vgm_import$vgm_stats %>% pull(nlag)
tail = vgm_import$vgm_stats %>% pull(tail)
head = vgm_import$vgm_stats %>% pull(head)

# load variogram
gam = vgm_import$vgm %>% as_tibble()
vartype = 1

#specify model
nugget = c(0, 7500, 7500, 0, 0, 0, 0, 1)
spherical = c(1, 7500, 7500, 0, 0, 0, 0, 1)
linear = c(5, 7500, 7500, 0, 0, 0, 0, 1)
model = rbind(nugget, spherical, linear)
weighting_method = 1
```

Inputs

*azm* - azimuth for sample variogram/covariance (nvariogram * 1 vector). That is,
what azimuth is the variogram computed at? Units in degrees

*dip* - dips for sample variogram/covariance (nvariog * 1 vector). That is, what 
dip is the variogram computed at? Units in degrees

*nlag*  - number of lags for each variogram/correlogram (nvariog * 1 vector), defines 

*tail* - tail variables (nvariog * 1 vector), an integer vector of the variables at the tail of the variogram (1 -> 1 is a variogram, 1->2 is a covariogram)

*head* - head variables (nvariog * 1 vector), an integer vector the variables at the head of the variogram/covariance.

*model* - the variogram/covariance model matrix with dimensions of the number of structures (n_structures) * 8. Each row refers to a nested structure, codified as [type, scale factors, angles, shape parameter]. There are three scale factors (along the rotated y, x and z axes) and three angles to define the coordinate rotation (azimuth, dip and plunge). See Deutsch and Journel, 1992, p. 25. This port of Emery's code accepts the following types: nugget (0), spherical (1), exponential(2), gamma(3), Gaussian(6), linear(14). Angles in degrees.

*weighting_method* - the method used to quantify weights of points: 0: no weighting, 1: weights proportional to number of pairs, 2: weights inversely proportional to distance, 3: weights proportional to number of pairs and inversely proportional to distance. All weights must add to 1 (normalized)

*gam* - dataframe of simple and cross variograms/covariances. The shape of the dataframe should be sum(nlag) rows x 3 columns. Columns must correspond to [lag_distance, n_pairs, variance/covariance]. Must match up with the number of variograms and the specified lags in nlag.

*vartype* - the script handles traditional variograms (1) or centered covariances (2).

Outputs

*sills* - sills of nested structures (n_structures * n_fields^2 matrix)
*WSS* - weighted sum of squares for optimal fit

Default Hyperparameters

Iterations are stopped when 1) the number of iterations without modification is greater than maxiterations,  or 2) the computing time is greater than max_time_s. Parameters maxiterations and max_time_s can be modified in the script below, as well as the cooling parameters and correlation between generated Gaussian vectors.

Hyperparameters:
- maxiterations: maximum number of consecutive iterations with no accepted transitions
- max_time_s: maximum processing time in seconds
- cooling parameters (p_acc_0/p_acc_2k): probability of accepting a non-favorable transition at iteration 0 and 2000 - maps the cooling relationship
- vector correlation: correlation between generated Gaussian vectors
gen_vec_corr = 0.9; % correlation between generated Gaussian vectors

```{r}
res <- fit_linear_model_of_coregionalization(
  azimuth, dip, nlag, tail, head, gam, model, vartype
  )
```
