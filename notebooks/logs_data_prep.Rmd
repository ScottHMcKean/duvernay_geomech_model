---
title: "las_reader"
output: html_document
---

This notebook loads the .las files from the raw data folder, intersects
them with the top and base of the Duvernay, and saves the logs back to 
data-raw folder. Upscaled point values will be provided for reproducibility
once the Duvernay B Carbonate is identified.

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(data.table)
library(raster)
library(sf)

# From geospatial_layers_prep.Rmd
study_bounds = st_read('../data/study_bounds.GeoJSON')
study_proj = st_crs(study_bounds)$proj4string
study_raster = raster('../data/study_raster.tif')
study_dv_bounds = st_read('../data/study_dv_bounds.GeoJSON')
surface_locs = st_read('../data/study_surf_locs.GeoJSON')
dv_top = raster('../data/dv_top_masl.tif')
dv_base = raster('../data/dv_base_masl.tif')
dv_iso = raster('../data/dv_iso_m.tif')
```

# Pull up las files

```{r}
las_file_paths <- list.files('../data-raw/las_files/', full.names = TRUE)
las_file_names <- list.files('../data-raw/las_files/', full.names = FALSE)

las_file_uwis <- las_file_names %>%
    str_replace_all(., '.las', '') %>%
    str_replace_all(., 'w', 'W')
```

# Get unique study locations 

We take mean surface location for point locations, since there are multiple 
coordinates for many uwis. Select pertinent columns and make sure the projection
is right.

```{r}
study_locs = surface_locs %>% 
  filter((surface_locs$uwi %in% las_file_uwis)) %>%
  dplyr::select(uwi, latitude, longitude, kbe, ground_elev, geometry) %>% 
  group_by(uwi) %>% 
  summarize_all(mean) %>%
  st_simplify()

# verify projections
ggplot() +
  geom_sf(data=study_dv_bounds) +
  geom_sf(data=study_locs)
```
# Extract the Duvernay Top and Base

We lose 4 wells on the outside of the study area because the AGS layer doesn't
have values for them, but this shouldn't affect the results too much, and 
ordinary kriging created way too much variance (~500 m) when trying to predict
the tops, so it wasn't feasible to interpolate the top and base.

```{r}
study_points <- study_locs %>%
  dplyr::select(uwi,geometry) %>%
  as(., 'Spatial')

tops <- study_locs %>%
  mutate(dv_top = raster::extract(dv_top, study_points, method='bilinear')) %>%
  mutate(dv_base = raster::extract(dv_base, study_points, method='bilinear')) %>%
  drop_na()
```

# Get Logs

Okay, so we have 104 logs in our study area with tops. Not bad. Now we take those logs, 
subset using the AER 3D model (duvernay top and base). 

```{r}
study_las_file_paths = las_file_paths[las_file_uwis %in% tops$uwi]
```

```{r}
las_dfs <- map(.x = study_las_file_paths, get_log_data, study_locs, dv_base, dv_top)

log_names <- map(.x = las_dfs, .f = colnames) %>%
  unlist() %>%
  unique()

comb_las_df <- bind_rows(las_dfs) %>%
  group_by(uwi) %>%
  mutate(rel_depth_m = depth_m - min(depth_m)) %>%
  dplyr::ungroup()

colnames(comb_las_df) <- colnames(comb_las_df) %>% str_replace(., '_qcgeo', '')

comb_las_df %>% fwrite(., '../data-raw/logs_df.csv')

log_summary = comb_las_df %>%
  group_by(uwi) %>%
  summarise(rows = n(), 
            rhob = sum(na.omit(rhob_k_m) > 0),
            dtc = sum(na.omit(dtc_us_m) > 0),
            dts = sum(na.omit(dts_us_m) > 0),
            gr = sum(na.omit(gr_gapi) > 0)
            )
```

```{r}
comb_las_df %>%
  group_by(uwi) %>%
  mutate(rel_depth_m = depth_m - min(depth_m))

plot_ly(
  comb_las_df %>% filter(uwi=='103162506119W500'), x = ~elev_masl, y = ~dtc_us_m, 
  name = 'DTC', type = 'scatter', mode = 'lines', orientation='h') %>% 
  add_trace(y = ~gr_gapi, name = 'GR', mode = 'lines+markers')

```
