---
title: "Predict with Model & Geostats"
output: html_document
---

This notebook summarizes the model predictions. We try to answer the following:

- What is the mean prediction from each model?
- What is the uncertainity of each model?

By each model we mean model & facies. 

- We have three models from each feature set to help us evaluate model uncertainty,
plus the bias and variance of each model
- We have two facies to evaluate using the same model to evaluate facies uncertainty
- We have 1000 geostatistical simulations to help us evaluate geostatistical uncertainty

Uncertainty = mean model variance + 
  different model uncertainty + 
  facies uncertainty +
  geostatistical uncertainty

```{r setup}
library(duvernaygeomechmodel)
study_bounds = st_read('../data/study_dv_bounds.GeoJSON')
study_raster = raster::raster('../data/study_raster.tif')
```

Load predictions from the previous notebook

```{r}
predictions = readRDS('../output/geostatistical_models/predictions.rds')
rock_phys_pred = readRDS('../output/geostatistical_models/rock_phys_predictions.rds')
```

Get a list of models

```{r}
folders = c()
for (dir in list.dirs("../output/statistical_models/",recursive = FALSE)){
    folders = append(folders, tail(str_split(dir,'/')[[1]],1))
}
```
Pick a feature set

```{r}
feat_sets = c("vp_rho", "vp_vs_rho", "dev_vp_rho", "dev_vp_vs_rho", 
              "dev_conf_vp_rho", "dev_conf_vp_vs_rho")

targets = c("br", "ym", "pr")

facies = c("shale", "carb")

models = c("glm", "mars", "rf")

subset_options = expand.grid(
  feat_sets=feat_sets, targets=targets, facies=facies, models=models,
  stringsAsFactors=FALSE)

subset_predictions <- function(predictions, feat_set, target, facies, model){
  predictions@data <- predictions@data %>% 
    select(contains(feat_set)) %>%
    select(contains(target)) %>%
    select(contains(facies)) %>%
    select(contains(model))
  predictions
}
```

Subset predictions and make summary graphs / table

```{r}
for (row in 1:nrow(subset_options)){
  print(row)
  feat_set = subset_options[row, 'feat_sets']
  target = subset_options[row, 'targets']
  facie = subset_options[row, 'facies']
  model = subset_options[row, 'models']
  
  subset_name = str_c(facie, "_", feat_set, "_", model, "_", target)
  file_prefix = str_c("../output/prediction_summaries/", subset_name)

  # select a single set of realizations
  pred_subset = subset_predictions(
    predictions, feat_set, target, facie, model
    )
  
  #Summarize a subset
  # get rowwise summary statistics for the feature subset
  pred_subset_summary = pred_subset@data %>%
    rowwise() %>%
    summarize(
      mean = mean(c_across()),
      sd = sd(c_across()),
      p05 = quantile(c_across(), 0.05, na.rm=TRUE),
      p95 = quantile(c_across(), 0.95, na.rm=TRUE)
    ) %>%
    mutate(ci90 = p95-p05) %>%
    mutate(x = pred_subset@coords[,1]) %>%
    mutate(y = pred_subset@coords[,2])
  
  # output
  write_csv(pred_subset_summary, 
    str_c(file_prefix, "_predsummary.csv")
    )
  
  #Make plots
  ## Make some rules for plot censoring
  if (target == 'ym'){
    mean_lim = c(15,85)
    sd_lim = c(0,20)
    ci90_lim = c(0,20)
  } else if (target == 'pr'){
    mean_lim = c(0.1,0.5)
    sd_lim = c(0,0.2)
    ci90_lim = c(0,0.2)
  } else {
    mean_lim = c(0.2,0.5)
    sd_lim = c(0,0.2)
    ci90_lim = c(0,0.2)
  }
  
  ## Make plots
  ggplot(data = pred_subset_summary) +
    geom_tile(aes(x=x, y=y, fill=mean)) +
    scale_fill_viridis_c(limits=mean_lim, oob=scales::squish) +
    coord_equal() +
    theme_minimal() +
    ylab("") + xlab("") +
    ggtitle(str_c(subset_name, " mean")) +
    ggsave(str_c(file_prefix, "_meanplot.pdf"))
  
  ggplot(data = pred_subset_summary) +
    geom_tile(aes(x=x, y=y, fill=sd)) +
    scale_fill_viridis_c(limits=sd_lim, oob=scales::squish) +
    coord_equal() +
    theme_minimal() +
    ylab("") + xlab("") +
    ggtitle(str_c(subset_name, " sd")) +
    ggsave(str_c(file_prefix, "_sdplot.pdf"))
  
  ggplot(data = pred_subset_summary) +
    geom_tile(aes(x=x, y=y, fill=ci90)) +
    scale_fill_viridis_c(limits=ci90_lim, oob=scales::squish) +
    coord_equal() +
    theme_minimal() +
    ylab("") + xlab("") +
    ggtitle(str_c(subset_name, " ci90")) +
    ggsave(str_c(file_prefix, "_ci90plot.pdf"))
}
```
